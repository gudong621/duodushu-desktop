# 多读书 - 产品需求文档（PRD）

**版本**: 1.0
**日期**: 2026-01-27
**项目代号**: 多读书 (duodushu)
**语言**: 简体中文

---

## 1. 产品概述

### 1.1 产品定位

**多读书（duodushu）** 是一款沉浸式英语学习平台，旨在通过 AI 辅助阅读、智能词典查询和上下文感知的学习功能，提升用户的英语阅读效率和学习体验。

**核心价值主张**：
- **沉浸式阅读**：支持 PDF、EPUB、TXT 等多种格式的文档阅读
- **智能词典**：三级查询机制（缓存→本地→AI），快速准确获取词汇释义
- **AI 老师助手**：基于当前阅读内容的智能问答和讲解
- **单词本管理**：智能优先级评分系统，科学安排复习计划
- **全文检索**：基于 FTS5 的跨书籍全文搜索，快速定位知识点

### 1.2 目标用户

| 用户类型 | 用户画像 | 核心需求 |
|---------|----------|----------|
| **英语学习者** | 需要阅读英文原版书籍的学习者，水平从初级到高级 | 查词便利、例句丰富、语法讲解 |
| **英语教师** | 需要使用英文教材教学的教师 | 快速定位知识点、生成教学内容 |
| **外语考试备考者** | 准备托福、雅思、GRE 等考试的学生 | 生词管理、复习提醒、高频词学习 |
| **英语阅读爱好者** | 喜欢阅读英文小说、科技文献的爱好者 | 流畅阅读体验、笔记整理 |

### 1.3 核心功能矩阵

| 功能模块 | 优先级 | 状态 | 备注 |
|---------|--------|------|------|
| 多格式阅读器 | P0 | ✅ 已实现 | PDF/EPUB/TXT |
| 智能词典查询 | P0 | ✅ 已实现 | 三级查询机制 |
| AI 老师助手 | P0 | ✅ 已实现 | 意图识别 + 上下文感知 |
| 单词本管理 | P0 | ✅ 已实现 | 优先级评分系统 |
| 全文检索 | P1 | ✅ 已实现 | FTS5 跨书籍搜索 |
| TTS 语音合成 | P1 | ✅ 已实现 | Edge-TTS 本地缓存 |
| 笔记与书签 | P1 | ✅ 已实现 | 本地存储 |
| 单词复习模式 | P2 | ✅ 已实现 | 闪卡交互 |
| 例句提取 | P2 | ✅ 已实现 | 后台异步任务 |

---

## 2. 功能详细需求

### 2.1 阅读器功能

#### 2.1.1 文件格式支持

**需求描述**：
- 支持 PDF 格式阅读
- 支持 EPUB 格式阅读
- 支持 TXT 格式阅读
- 自动识别文件类型并选择对应的解析器

**技术实现**：
- PDF：使用 PyMuPDF (fitz) 提取文本和字符坐标
- EPUB：使用 ebooklib 解析章节，BeautifulSoup 清洗 HTML
- TXT：自动识别编码（UTF-8/GBK），按段落分页

**验收标准**：
- [ ] PDF 文档正确渲染，文本可复制
- [ ] EPUB 文档正确渲染，支持目录跳转
- [ ] TXT 文档正确渲染，自动换行
- [ ] 支持大文件（>100MB）的流畅阅读

#### 2.1.2 阅读交互

**需求描述**：
- 支持翻页操作（上一页/下一页/跳转）
- 支持目录导航（EPUB）/ 书签导航
- 支持页面缩放（PDF）
- 支持全屏模式
- 自动保存阅读进度

**验收标准**：
- [ ] 翻页响应时间 < 300ms
- [ ] 阅读进度自动保存，下次打开恢复到上次位置
- [ ] 支持 URL 参数跳转（`?page=10`）
- [ ] 支持目录点击跳转（EPUB）

#### 2.1.3 选词与划词

**需求描述**：
- 点击单词自动查词
- 选中文本触发工具栏（查词/问AI/复制/笔记）
- 支持单词坐标点击（PDF/EPUB）
- 支持文本选择（TXT）

**验收标准**：
- [ ] 单词点击响应时间 < 200ms
- [ ] 选词工具栏跟随选中位置
- [ ] 支持多行文本选择
- [ ] 选词后自动提取上下文句子

### 2.2 智能词典功能

#### 2.2.1 三级查询机制

**需求描述**：
- **第一级**：缓存查询（SQLite cache_dictionary 表）
- **第二级**：本地词典查询（ECDICT/MDX 导入词典）
- **第三级**：AI 生成释义（DeepSeek API，已降级为免费 API）

**查询流程**：
```
用户查词
    ↓
1. 查询缓存（cache_dictionary）
    ↓ 命中
返回结果
    ↓ 未命中
2. 查询本地词典（ECDICT/MDX）
    ↓ 命中
返回结果 + 缓存到 cache_dictionary
    ↓ 未命中
3. 查询外部 API（Free Dictionary API）
    ↓ 成功
返回结果 + 缓存到 cache_dictionary
```

**验收标准**：
- [ ] 缓存命中时间 < 50ms
- [ ] 本地词典查询时间 < 200ms
- [ ] 外部 API 查询时间 < 3s
- [ ] 所有查询结果统一为 JSON 格式

#### 2.2.2 多词典支持

**需求描述**：
- 支持导入 MDX/MDD 格式词典
- 支持切换词典源（牛津、朗文、柯林斯等）
- 支持词典源优先级设置
- 支持词典管理（导入/删除/列表）

**验收标准**：
- [ ] 支持导入多本词典（<2GB/本）
- [ ] 切换词典源时保持当前上下文
- [ ] 词典列表页面显示所有已导入词典
- [ ] 删除词典时清理关联数据

#### 2.2.3 词形还原

**需求描述**：
- 自动识别单词变形（复数、过去式、进行时）
- 支持不规则动词变形
- 提供例外词列表（如 "evening" 不应还原为 "even"）

**验收标准**：
- [ ] "books" → "book"（复数还原）
- [ ] "went" → "go"（不规则过去式）
- [ ] "running" → "run"（进行时还原）
- [ ] 例外词列表准确，不误还原

### 2.3 AI 老师助手

#### 2.3.1 意图识别

**需求描述**：
- 自动识别用户意图，路由到不同处理模式
- **语言学习模式**：讲解语法、词汇、翻译句子（默认单页模式）
- **内容定位模式**：查找内容在哪一页、定位知识点
- **知识检索模式**：某个概念在哪里讲过（全书范围）
- **阅读理解模式**：总结、分析全书内容

**关键词增强**：
- 支持中英文双语关键词识别（如 "summarize", "where", "plot"）
- 支持多学科同义词扩展搜索（天文、地理、物理、生物等专业词汇自动映射）
- 智能排除页面指令（如 "这一页" 强制使用单页模式）

**关键词示例**：
- 语言学习：`讲解一下这个句子`、`explain`、`grammar`
- 内容定位：`这个概念在第几页`、`where is`、`find`
- 知识检索：`这个概念在其他地方有讲吗`、`mentioned`
- 阅读理解：`总结一下这本书`、`summarize`、`main idea`

**验收标准**：
- [ ] 意图识别准确率 > 90%
- [ ] 支持中英文混合关键词
- [ ] 学科专业词汇自动扩展同义词搜索
- [ ] 意图识别日志记录（用于优化）

#### 2.3.2 上下文感知对话

**需求描述**：
- AI 老师基于当前阅读页面的内容回答问题
- 支持上下文窗口（最近 5000 字符）
- 支持对话历史记录
- 支持跨页面上下文（全书模式）

**验收标准**：
- [ ] AI 回答内容与当前页面相关度 > 80%
- [ ] 对话历史按页面分组存储
- [ ] 支持页面/全书视图切换
- [ ] 对话历史本地持久化（localStorage）

#### 2.3.3 推荐问题生成

**需求描述**：
- AI 回答后自动生成 3 个相关问题
- 问题围绕当前回答内容
- 问题具体、可操作
- 点击问题自动发送

**格式要求**：
```
【推荐问题】
- 问题1
- 问题2
- 问题3
```

**验收标准**：
- [ ] 每次回答后生成 3 个相关问题
- [ ] 问题与当前回答相关度 > 70%
- [ ] 点击问题后自动发送到 AI
- [ ] 问题格式严格符合规范

### 2.4 单词本管理

#### 2.4.1 单词收藏

**需求描述**：
- 点击"添加到单词本"按钮收藏单词
- 自动保存上下文句子
- 自动记录书籍来源和页码
- 支持编辑释义和备注

**验收标准**：
- [ ] 收藏成功提示 < 500ms
- [ ] 自动保存完整上下文句子
- [ ] 支持从单词本删除单词
- [ ] 支持批量导出单词本

#### 2.4.2 优先级评分系统

**需求描述**：
- 基于以下因素计算单词优先级分数：
  - 查询次数（query_count）
  - 复习次数（review_count）
  - 掌握度（mastery_level，1-5）
  - 最后查询时间（last_queried_at）
  - 创建时间（created_at）
- 优先级分数范围：0-100
- 定时任务每日凌晨 3 点更新所有单词优先级

**评分算法**（简化版）：
```
priority_score = (query_count * 10) +
               (review_count * 5) +
               ((5 - mastery_level) * 10) +
               time_decay_score
```

**学习状态分类**：
- **urgent** (priority_score >= 80)：紧急复习
- **review** (60 <= priority_score < 80)：需要复习
- **learning** (40 <= priority_score < 60)：学习中
- **mastered** (priority_score < 40)：已掌握

**验收标准**：
- [ ] 优先级分数实时更新（查询/复习时）
- [ ] 定时任务每日凌晨 3 点执行
- [ ] 单词列表支持按优先级排序
- [ ] 高优先级单词（>70）自动提醒

#### 2.4.3 例句提取

**需求描述**：
- 收藏单词后自动从其他书籍提取例句
- 使用 FTS5 全文搜索匹配单词
- 支持词形还原匹配变体
- 标记例句来源（用户收藏/例句库）
- 每个单词最多保存 10 个例句

**提取规则**：
- 优先从 `book_type = 'example_library'` 的书籍提取
- 句子长度：10-800 字符
- 过滤列表、目录、标题等非句子内容
- 每页最多提取 1 个例句
- 支持通过 API (`/api/vocabulary_snippet/{vocab_id}/extract_examples`) 手动触发提取任务

**验收标准**：
- [ ] 后台任务在收藏后 10s 内启动
- [ ] 支持手动触发任务补充例句
- [ ] 例句提取成功率 > 80%
- [ ] 例句质量过滤准确率 > 90%
- [ ] 例句来源标记正确

#### 2.4.4 单词复习模式

**需求描述**：
- 基于优先级排序的闪卡复习界面
- 正面显示单词，反面显示释义
- 点击翻转卡片
- 滑动操作：向左（不会）/向右（会）跳转
- 自动更新掌握度和复习次数

**验收标准**：
- [ ] 卡片翻转动画流畅（< 200ms）
- [ ] 滑动操作响应准确率 > 95%
- [ ] 复习后优先级实时更新
- [ ] 支持一键清空当前会话

### 2.5 全文检索功能

#### 2.5.1 跨书籍搜索与知识问答

**需求描述**：
- 基于 SQLite FTS5 全文搜索实现检索增强生成 (RAG)
- **关键词搜索**：支持词形还原的精确/模糊匹配
- **语义扩展**：支持中英文同义词自动扩展查询
- **知识问答**：基于检索到的上下文（Snippet）由 AI 生成最终回答
- **来源引用**：AI 回答中必须标注来源页码（如【来源1 - 第50页】）

**搜索范围**：
- 所有已解析的书籍内容（pages 表）
- 支持按书籍类型筛选（normal/example_library）

**验收标准**：
- [ ] 搜索响应时间 < 1s（万页级数据）
- [ ] 知识问答准确引用原文页码
- [ ] 支持无结果时的同义词自动重试机制
- [ ] 搜索结果按 FTS5 rank 排序

#### 2.5.2 FTS5 索引

**需求描述**：
- 书籍解析时自动创建 FTS5 虚拟表
- 索引字段：text_content（页面文本内容）
- 支持增量更新（新页面自动索引）
- 支持触发重建（管理员功能）

**验收标准**：
- [ ] 解析时自动创建索引
- [ ] 索引创建时间 < 5s（千页级数据）
- [ ] 索引文件大小 < 原文本大小 * 1.5
- [ ] 搜索时自动使用 FTS5 表

### 2.6 TTS 语音合成

#### 2.6.1 文本朗读

**需求描述**：
- 支持单词发音朗读
- 支持句子朗读
- 支持整页朗读
- 使用 Edge-TTS（本地缓存）
- 支持语音选择（美式/英式）

**验收标准**：
- [ ] TTS 响应时间 < 2s（首次）
- [ ] 缓存命中时间 < 100ms
- [ ] 语音质量清晰度 > 4/5 分
- [ ] 支持音频播放控制（播放/暂停/停止）

---

## 3. 非功能性需求

### 3.1 性能需求

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 首页加载时间 | < 2s | Chrome DevTools Network 面板 |
| 阅读器翻页时间 | < 300ms | 性能监控工具 |
| 词典查询响应 | < 200ms（缓存）/ < 3s（API） | API 日志 |
| AI 对话响应 | < 5s | DeepSeek API 响应时间 |
| 全文检索响应 | < 1s | SQLite 查询日志 |
| 页面内存占用 | < 200MB | Chrome DevTools Memory 面板 |

### 3.2 可用性需求

- **易学性**：新用户 5 分钟内掌握核心功能
- **效率性**：完成常用操作（查词/划词/笔记）< 3 步
- **容错性**：操作错误可撤销，支持数据恢复
- **满意度**：用户满意度 > 4/5 分（问卷调查）

### 3.3 兼容性需求

| 平台 | 支持版本 | 备注 |
|------|----------|------|
| Chrome | 最新 2 个版本 | 主要测试浏览器 |
| Firefox | 最新 2 个版本 | 兼容性测试 |
| Safari | 最新 2 个版本 | macOS/iOS 支持 |
| Edge | 最新 2 个版本 | Windows 默认浏览器 |

### 3.4 安全性需求

- **数据安全**：用户数据本地存储（localStorage），不上传云端
- **API 安全**：所有 API 调用通过 Next.js Rewrite 代理，避免 CORS
- **输入验证**：所有用户输入在前后端双重验证
- **路径防护**：文件上传路径遍历攻击防护
- **SQL 注入防护**：使用 SQLAlchemy ORM 参数化查询

### 3.5 可维护性需求

- **代码规范**：遵循 ESLint/PyLint 规范，无严重警告
- **文档完整**：核心模块 100% 覆盖文档注释
- **测试覆盖**：核心业务逻辑测试覆盖率 > 80%
- **日志记录**：关键操作日志记录，支持问题排查

---

## 4. 数据需求

### 4.1 数据实体

| 实体 | 主要字段 | 关系 |
|------|----------|------|
| Book | id, title, author, format, file_path, cover_image, total_pages, status, book_type | 1:N Page, 1:N ReadingProgress |
| Page | id, book_id, page_number, text_content, words_data, images | N:1 Book |
| Vocabulary | id, word, phonetic, definition, translation, book_id, page_number, context, mastery_level, review_count, priority_score | N:1 Book |
| WordContext | id, word, book_id, page_number, context_sentence, is_primary, source_type | 关联 Vocabulary 和 Book |
| CacheDictionary | word, data, created_at | 缓存表 |
| Bookmark | id, book_id, page_number, title, note, created_at | N:1 Book |
| ReadingProgress | id, book_id, current_page, total_read_time, updated_at | N:1 Book |

### 4.2 数据存储

- **数据库**：SQLite (aiosqlite 异步驱动)
- **数据库文件**：`data/*.db`（不提交到 Git）
- **文件存储**：`uploads/` 目录（书籍、封面、音频缓存）
- **前端存储**：localStorage（对话历史、笔记、设置）

---

## 5. 界面需求

### 5.1 布局设计

**三栏布局**（桌面端）：
- **左侧栏**（320px-600px）：目录、书签
- **中间栏**（自适应）：阅读器
- **右侧栏**（320px-600px）：词典、AI 老师、笔记

**响应式设计**：
- **桌面端**（>768px）：三栏布局
- **移动端**（<=768px）：单栏布局，侧边栏可折叠

### 5.2 视觉设计

**设计风格**：简洁、现代、学习导向
- **主色调**：灰色系（gray-50 到 gray-900）
- **强调色**：黄色（划词高亮）、蓝色（AI 对话）
- **字体**：系统默认字体，阅读器使用无衬线字体
- **间距**：统一使用 4px 网格系统

### 5.3 交互设计

**动画过渡**：
- 页面切换：淡入淡出（300ms）
- 侧边栏展开/折叠：滑动（200ms）
- 卡片翻转：3D 旋转（200ms）
- 按钮悬停：背景色变化（150ms）

**交互反馈**：
- 点击操作：视觉反馈（按钮按下状态）
- 加载状态：Spinner 加载指示器
- 错误提示：Toast 消息通知
- 成功提示：Checkmark 图标

---

## 6. 版本规划

### 6.1 已完成功能（v1.0）

- ✅ PDF/EPUB/TXT 多格式阅读器
- ✅ 三级词典查询机制
- ✅ AI 老师助手（意图识别 + 上下文感知）
- ✅ 单词本管理（优先级评分系统）
- ✅ 例句自动提取（FTS5 全文搜索）
- ✅ 全文检索功能
- ✅ TTS 语音合成（Edge-TTS）
- ✅ 笔记与书签管理

### 6.2 规划中功能（v1.1）

- 🔄 单词本数据导入/导出（CSV/JSON）
- 🔄 阅读统计报表（阅读时长、页数、单词数）
- 🔄 离线模式支持（Service Worker 缓存）
- 🔄 多用户支持（用户登录/权限管理）
- 🔄 同步云端存储（可选）

### 6.3 未来规划（v2.0）

- ⏳ AI 写作助手（基于阅读内容的写作建议）
- ⏳ 智能摘要生成（全书章节摘要）
- ⏳ 个性化学习路径（基于词汇量推荐）
- ⏳ 协作学习模式（共享笔记/讨论）
- ⏳ 移动端 App（React Native 版本）

---

## 7. 风险与挑战

### 7.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AI API 成本过高 | 影响功能可用性 | 降级策略：优先使用免费 API（Free Dictionary），AI 作为备选 |
| 大文件解析性能 | 用户体验差 | 后台异步解析，分批处理 |
| FTS5 索引膨胀 | 存储空间占用大 | 定期清理无用索引，压缩存储 |
| 浏览器兼容性 | 部分用户无法使用 | 主流浏览器测试，提供 Polyfill |

### 7.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 用户学习习惯差异 | 功能使用率低 | 提供多种使用模式（沉浸/高效/复习） |
| 内容质量不稳定 | AI 回答质量差 | 用户反馈机制，持续优化 Prompt |
| 数据丢失风险 | 用户投诉 | 定期提醒用户备份数据，提供导出功能 |

---

## 8. 成功指标

### 8.1 用户增长

- **日活跃用户（DAU）**：目标 1000+（6 个月内）
- **周活跃用户（WAU）**：目标 3000+（6 个月内）
- **月活跃用户（MAU）**：目标 10000+（6 个月内）

### 8.2 功能使用

- **查词次数**：目标 10 次/用户/天
- **AI 对话次数**：目标 5 次/用户/天
- **单词本收藏量**：目标 50 词/用户（30 天内）
- **阅读时长**：目标 30 分钟/用户/天

### 8.3 用户满意度

- **用户满意度评分**：目标 > 4/5 分
- **功能完成率**：目标 > 80%
- **用户留存率**：目标 7 日留存 > 40%
- **NPS（净推荐值）**：目标 > 30

---

## 9. 附录

### 9.1 术语表

| 术语 | 解释 |
|------|------|
| FTS5 | SQLite 全文搜索扩展 |
| MDX/MDD | 词典数据文件格式 |
| ECDICT | 英汉词典数据库 |
| Edge-TTS | Microsoft Edge 语音合成 API |
| AI 老师 | 基于 LLM 的智能问答系统 |
| 三级查询 | 缓存→本地→AI 的词典查询机制 |

### 9.2 参考资料

- [Next.js 官方文档](https://nextjs.org/docs)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [React 19 文档](https://react.dev/)
- [Tailwind CSS 4 文档](https://tailwindcss.com/)
- [SQLite FTS5 文档](https://www.sqlite.org/fts3.html)
- [DeepSeek API 文档](https://api-docs.deepseek.com/)

---

**文档结束**
