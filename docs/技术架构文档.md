# å¤šè¯»ä¹¦ - æŠ€æœ¯æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0
**æ—¥æœŸ**: 2026-01-27
**é¡¹ç›®ä»£å·**: å¤šè¯»ä¹¦ (duodushu)
**æŠ€æœ¯æ ˆ**: Next.js 16 + FastAPI + SQLite

---

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æµè§ˆå™¨ç«¯    â”‚  â”‚  ç§»åŠ¨ç«¯ï¼ˆè§„åˆ’ï¼‰â”‚  â”‚  API å®¢æˆ·ç«¯ï¼ˆè§„åˆ’ï¼‰â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                    â”‚                     â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Next.js å‰ç«¯å±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ App Router è·¯ç”±                                        â”‚
â”‚  â€¢ React 19 ç»„ä»¶æ¸²æŸ“                                      â”‚
â”‚  â€¢ Tailwind CSS 4 æ ·å¼                                      â”‚
â”‚  â€¢ TypeScript 5 ç±»å‹å®‰å…¨                                     â”‚
â”‚  â€¢ Zustand çŠ¶æ€ç®¡ç†ï¼ˆè§„åˆ’ï¼‰                                  â”‚
â”‚  â€¢ IndexedDB æœ¬åœ°å­˜å‚¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI åç«¯å±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Router å±‚   â”‚  â”‚  Service å±‚   â”‚  â”‚  Model å±‚    â”‚      â”‚
â”‚  â”‚ (API è·¯ç”±)  â”‚  â”‚ (ä¸šåŠ¡é€»è¾‘)   â”‚  â”‚ (æ•°æ®æ¨¡å‹)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                    â”‚                     â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                      â”‚                    â”‚                       â”‚
â”‚                      â–¼                    â–¼                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚              â”‚  Parser å±‚    â”‚  â”‚  Utils å±‚     â”‚            â”‚
â”‚              â”‚ (æ–‡æ¡£è§£æ)    â”‚  â”‚ (å·¥å…·å‡½æ•°)     â”‚            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æŒä¹…åŒ–å±‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  SQLite ä¸»åº“ â”‚  â”‚  MDX ç´¢å¼•åº“   â”‚  â”‚  æ–‡ä»¶å­˜å‚¨     â”‚      â”‚
â”‚  â”‚  (ç”¨æˆ·æ•°æ®)   â”‚  â”‚  (è¯å…¸æ•°æ®)    â”‚  â”‚  (uploads/)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚  FTS5 å…¨æ–‡   â”‚  â”‚  ECDICT è¯å…¸  â”‚                         â”‚
â”‚  â”‚  æœç´¢ç´¢å¼•    â”‚  â”‚  (æœ¬åœ°è‹±æ±‰)  â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡å±‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  DeepSeek API â”‚  â”‚  Edge-TTS API â”‚  â”‚  åœ¨çº¿è¯å…¸API   â”‚      â”‚
â”‚  â”‚  (AI æŸ¥è¯¢)   â”‚  â”‚  (è¯­éŸ³åˆæˆ)   â”‚  â”‚  (å­—å…¸å¤‡ç”¨)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **å‰ç«¯æ¡†æ¶** | Next.js | 16.1.1 | App Router è·¯ç”± |
| **å‰ç«¯æ ¸å¿ƒ** | React | 19.2.3 | å‡½æ•°å¼ç»„ä»¶ + Hooks |
| **ç±»å‹ç³»ç»Ÿ** | TypeScript | 5 | ç±»å‹å®‰å…¨ |
| **æ ·å¼æ–¹æ¡ˆ** | Tailwind CSS | 4 | å®ç”¨ä¼˜å…ˆ CSS æ¡†æ¶ |
| **æ–‡æ¡£æ¸²æŸ“** | react-pdf | 10.3.0 | PDF æ–‡æ¡£æ¸²æŸ“ |
| **ç”µå­ä¹¦** | epub.js | 0.3.93 | EPUB æ–‡æ¡£æ¸²æŸ“ |
| **Markdown** | react-markdown | 10.1.0 | Markdown æ¸²æŸ“ |
| **åç«¯æ¡†æ¶** | FastAPI | 0.104+ | å¼‚æ­¥ Web æ¡†æ¶ |
| **ASGI æœåŠ¡å™¨** | Uvicorn | 0.24+ | Python å¼‚æ­¥æœåŠ¡å™¨ |
| **æ•°æ®éªŒè¯** | Pydantic | 2.0+ | æ•°æ®éªŒè¯å’Œåºåˆ—åŒ– |
| **ORM æ¡†æ¶** | SQLAlchemy | 2.0+ | Python ORM |
| **æ•°æ®åº“** | SQLite | 3.9+ | è½»é‡çº§åµŒå…¥å¼æ•°æ®åº“ |
| **å…¨æ–‡æœç´¢** | FTS5 | å†…ç½® | SQLite å…¨æ–‡æœç´¢æ‰©å±• |
| **ä»»åŠ¡è°ƒåº¦** | APScheduler | 3.10+ | åå°å®šæ—¶ä»»åŠ¡ |
| **HTTP å®¢æˆ·ç«¯** | httpx | 0.25+ | å¼‚æ­¥ HTTP è¯·æ±‚ |
| **AI æœåŠ¡** | OpenAI SDK | 1.0+ | DeepSeek API è°ƒç”¨ |
| **å¤‡ç”¨ AI** | Google Gemini | 0.3.0+ | å¤‡ç”¨ç”Ÿæˆå¼æ¨¡å‹ |
| **TTS æœåŠ¡** | edge-tts | 6.1.0 | Microsoft Edge TTS API |

---

## 2. å‰ç«¯æ¶æ„ï¼ˆNext.js 16ï¼‰

### 2.1 é¡¹ç›®ç»“æ„

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                          # Next.js App Router é¡µé¢
â”‚   â”‚   â”œâ”€â”€ layout.tsx                # å…¨å±€æ ¹å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ page.tsx                  # é¦–é¡µï¼ˆä¹¦æ¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ read/[id]/page.tsx        # é˜…è¯»é¡µé¢ï¼ˆçŠ¶æ€ç®¡ç†ä¸­å¿ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ vocabulary/               # è¯æ±‡å­¦ä¹ æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx              # ç”Ÿè¯æœ¬åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ [id]/page.tsx        # å•è¯è¯¦æƒ…
â”‚   â”‚   â”‚   â”œâ”€â”€ learn/page.tsx       # å­¦ä¹ æ¨¡å¼
â”‚   â”‚   â”‚   â””â”€â”€ review/page.tsx      # å¤ä¹ æ¨¡å¼
â”‚   â”‚   â””â”€â”€ dicts/page.tsx          # è¯å…¸ç®¡ç†
â”‚   â”œâ”€â”€ components/                   # React ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ UniversalReader.tsx        # ç»Ÿä¸€é˜…è¯»å™¨è°ƒåº¦
â”‚   â”‚   â”œâ”€â”€ PDFReader.tsx            # PDF é˜…è¯»å™¨
â”‚   â”‚   â”œâ”€â”€ EPUBReader.tsx           # EPUB é˜…è¯»å™¨
â”‚   â”‚   â”œâ”€â”€ TXTReader.tsx            # TXT é˜…è¯»å™¨
â”‚   â”‚   â”œâ”€â”€ AITeacherSidebar.tsx       # AI è€å¸ˆä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ DictionarySidebar.tsx      # è¯å…¸æŸ¥è¯¢ä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ NotesSidebar.tsx          # ç¬”è®°ç®¡ç†ä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ LeftSidebar.tsx           # å·¦ä¾§å¯¼èˆªæ ï¼ˆç›®å½•/ä¹¦ç­¾ï¼‰
â”‚   â”‚   â”œâ”€â”€ SelectionToolbar.tsx       # é€‰è¯å·¥å…·æ 
â”‚   â”‚   â””â”€â”€ dictionary/              # è¯å…¸ä¸“ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ hooks/                       # è‡ªå®šä¹‰ React Hooks
â”‚   â”‚   â”œâ”€â”€ useGlobalTextSelection.ts # å…¨å±€æ–‡æœ¬é€‰æ‹©
â”‚   â”‚   â””â”€â”€ useDictionaryAudio.ts     # è¯å…¸éŸ³é¢‘æ’­æ”¾
â”‚   â”œâ”€â”€ lib/                         # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ api.ts                   # API å®¢æˆ·ç«¯ï¼ˆ616 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ logger.ts                # ç»Ÿä¸€æ—¥å¿—å·¥å…·
â”‚   â”‚   â”œâ”€â”€ BingSpeechService.ts      # Bing TTS æœåŠ¡
â”‚   â”‚   â””â”€â”€ epubCache.ts            # EPUB ç¼“å­˜ç®¡ç†
â”‚   â””â”€â”€ styles/                      # æ ·å¼æ–‡ä»¶
â”‚       â””â”€â”€ dictionary/              # è¯å…¸ä¸“ç”¨ CSS
â”œâ”€â”€ public/                           # é™æ€èµ„æº
â”œâ”€â”€ package.json                      # ä¾èµ–é…ç½®
â”œâ”€â”€ tsconfig.json                     # TypeScript é…ç½®
â”œâ”€â”€ next.config.ts                    # Next.js é…ç½®ï¼ˆAPI Proxyï¼‰
â””â”€â”€ eslint.config.mjs                 # ESLint è§„åˆ™
```

### 2.2 è·¯ç”±æ¶æ„ï¼ˆApp Routerï¼‰

| è·¯ç”± | ç»„ä»¶ | åŠŸèƒ½ | è®¤è¯ |
|------|------|------|------|
| `/` | `page.tsx` | ä¹¦æ¶é¦–é¡µ + æ–‡ä»¶ä¸Šä¼  | æ—  |
| `/read/[id]` | `read/[id]/page.tsx` | é˜…è¯»å™¨ + AI è¾…åŠ© | æ—  |
| `/vocabulary` | `vocabulary/page.tsx` | ç”Ÿè¯æœ¬åˆ—è¡¨ | æ—  |
| `/vocabulary/[id]` | `vocabulary/[id]/page.tsx` | å•è¯è¯¦æƒ… | æ—  |
| `/vocabulary/learn` | `vocabulary/learn/page.tsx` | å­¦ä¹ æ¨¡å¼ | æ—  |
| `/vocabulary/review` | `vocabulary/review/page.tsx` | å¤ä¹ æ¨¡å¼ï¼ˆé—ªå¡ï¼‰ | æ—  |
| `/dicts` | `dicts/page.tsx` | è¯å…¸ç®¡ç† | æ—  |

### 2.3 çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

#### å½“å‰å®ç°
- **é¡µé¢çº§çŠ¶æ€**ï¼šReact Hooksï¼ˆuseState, useEffect, useRefï¼‰
- **å…¨å±€é€‰æ‹©çŠ¶æ€**ï¼šuseGlobalTextSelection Hookï¼ˆå…¨å±€ç›‘å¬æ–‡æœ¬é€‰æ‹©ï¼‰
- **éŸ³é¢‘æ’­æ”¾çŠ¶æ€**ï¼šuseDictionaryAudio Hookï¼ˆè¯å…¸éŸ³é¢‘ç®¡ç†ï¼‰
- **æœ¬åœ°å­˜å‚¨**ï¼šlocalStorageï¼ˆå¯¹è¯å†å²ã€ç¬”è®°ã€è®¾ç½®ï¼‰

#### è§„åˆ’æ–¹æ¡ˆï¼ˆZustandï¼‰
```typescript
// è§„åˆ’ä¸­çš„ Zustand Store ç¤ºä¾‹
import { create } from 'zustand'

interface ReadingState {
  currentPage: number
  totalPages: number
  setCurrentPage: (page: number) => void
}

export const useReadingStore = create<ReadingState>((set) => ({
  currentPage: 1,
  totalPages: 0,
  setCurrentPage: (page) => set({ currentPage: page }),
}))
```

### 2.4 API è°ƒç”¨æ¶æ„

#### ç»Ÿä¸€ API ä»£ç†
```typescript
// next.config.ts
async rewrites() {
  const API_BASE = process.env.API_BASE_URL || "http://localhost:8000"
  return [
    {
      source: "/api/:path*",
      destination: `${API_BASE}/api/:path*`,
    },
  ];
}
```

#### API å®¢æˆ·ç«¯ï¼ˆlib/api.tsï¼‰
```typescript
// æ ¸å¿ƒå‡½æ•°ï¼ˆ616 è¡Œï¼‰
export async function lookupWord(word: string, source?: string) { ... }
export async function getBooks() { ... }
export async function addVocabulary(data: VocabularyCreate) { ... }
export async function streamSpeech(text: string) { ... }
export async function trackWordQuery(data: TrackQueryData) { ... }
// ... å…¶ä»– 20+ ä¸ªå‡½æ•°
```

#### å‚æ•°å‘½åè§„èŒƒ
```typescript
// å‰ç«¯å‘é€ï¼ˆsnake_caseï¼‰
{
  message: "Hello",
  history: [...],
  page_content: "...",  // camelCase â†’ snake_case
  current_page: 1,
  book_title: "...",
  book_id: "xxx"
}
```

### 2.5 å…³é”®ç»„ä»¶æ¶æ„

#### é˜…è¯»å™¨è°ƒåº¦å™¨ï¼ˆUniversalReader.tsxï¼‰
```typescript
// Factory æ¨¡å¼æ ¹æ®æ ¼å¼é€‰æ‹©é˜…è¯»å™¨
switch (format) {
  case 'pdf':
    return <PDFReader {...props} />
  case 'epub':
    return <EPUBReader {...props} />
  case 'txt':
    return <TXTReader {...props} />
  default:
    return <div>ä¸æ”¯æŒçš„æ ¼å¼</div>
}
```

#### PDF é˜…è¯»å™¨ï¼ˆPDFReader.tsxï¼‰
- **æ¸²æŸ“å±‚**ï¼šreact-pdf çš„ `<Page />` ç»„ä»¶
- **TextLayer**ï¼šé€æ˜è¦†ç›–å±‚ï¼Œç”¨äºå•è¯ç‚¹å‡»äº¤äº’
- **åæ ‡è®¡ç®—**ï¼šåŸºäº `words_data` çš„æ–‡æœ¬å®šä½
- **ç¼©æ”¾æ”¯æŒ**ï¼šé¡µé¢ç¼©æ”¾ + Canvas é‡æ¸²æŸ“

#### EPUB é˜…è¯»å™¨ï¼ˆEPUBReader.tsxï¼‰
- **æ¸²æŸ“å¼•æ“**ï¼šepub.js çš„ `Rendition` å¯¹è±¡
- **å¯¼èˆªç³»ç»Ÿ**ï¼šç« èŠ‚å¯¼èˆª + é¡µç å®šä½
- **æ–‡æœ¬æå–**ï¼šå®æ—¶æå–å½“å‰ç« èŠ‚æ–‡æœ¬
- **ç›®å½•æ ‘**ï¼šTOC ç»“æ„å±•ç¤º

#### AI è€å¸ˆä¾§è¾¹æ ï¼ˆAITeacherSidebar.tsxï¼Œ739 è¡Œï¼‰
- **å¯¹è¯ç®¡ç†**ï¼šæŒ‰é¡µé¢åˆ†ç»„çš„å¯¹è¯å†å²ï¼ˆlocalStorageï¼‰
- **è§†å›¾æ¨¡å¼**ï¼šæœ¬é¡µå¯¹è¯ / å…¨ä¹¦å¯¹è¯åˆ‡æ¢
- **æ¨èé—®é¢˜**ï¼šAI å›ç­”åè‡ªåŠ¨ç”Ÿæˆ 3 ä¸ªç›¸å…³é—®é¢˜
- **æ¥æºå¼•ç”¨**ï¼šFTS5 æ£€ç´¢ç»“æœå±•ç¤ºï¼ˆæ”¯æŒè·³è½¬ï¼‰
- **é¡µé¢å†…å®¹æ„ŸçŸ¥**ï¼šå®æ—¶ `pageContent` prop + åŠ è½½çŠ¶æ€

#### è¯å…¸ä¾§è¾¹æ ï¼ˆDictionarySidebar.tsxï¼‰
- **å¤šæºæ”¯æŒ**ï¼šç‰›æ´¥ã€æœ—æ–‡ã€æŸ¯æ—æ–¯ã€éŸ¦æ°ã€å‰‘æ¡¥
- **è¯å½¢è¿˜åŸ**ï¼šè‡ªåŠ¨è¯†åˆ«å•è¯å˜å½¢
- **ä¸Šä¸‹æ–‡ä¾‹å¥**ï¼šä¸»è¦ä¸Šä¸‹æ–‡ + é¢å¤–ä¾‹å¥å±•ç¤º
- **éŸ³é¢‘æ’­æ”¾**ï¼šBing TTS WebSocket æœåŠ¡
- **æ”¶è—åŠŸèƒ½**ï¼šæ·»åŠ åˆ°å•è¯æœ¬

### 2.6 æ—¥å¿—ç³»ç»Ÿ

```typescript
// lib/logger.ts
const log = createLogger('ModuleName');

log.debug('è°ƒè¯•ä¿¡æ¯', { data });
log.info('ä¸€èˆ¬ä¿¡æ¯');
log.warn('è­¦å‘Šä¿¡æ¯');
log.error('é”™è¯¯ä¿¡æ¯', error);
```

**ç¯å¢ƒå˜é‡æ§åˆ¶**ï¼š
- `NEXT_PUBLIC_LOG_LEVEL=debug/info/warn/error/none`
- ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨å…³é—­æ—¥å¿—

---

## 3. åç«¯æ¶æ„ï¼ˆFastAPIï¼‰

### 3.1 é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/                              # FastAPI æ ¸å¿ƒåº”ç”¨
â”‚   â”œâ”€â”€ main.py                        # åº”ç”¨å…¥å£ï¼ˆCORS, å®šæ—¶ä»»åŠ¡ï¼‰
â”‚   â”œâ”€â”€ config.py                      # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models/                        # SQLAlchemy 2.0 ORM
â”‚   â”‚   â”œâ”€â”€ database.py                # æ•°æ®åº“ Session, BASE_DIR
â”‚   â”‚   â”œâ”€â”€ models.py                  # æ•°æ®æ¨¡å‹ï¼ˆ8 ä¸ªè¡¨ï¼‰
â”‚   â”‚   â””â”€â”€ page_chunk.py            # é¡µé¢åˆ‡ç‰‡æ¨¡å‹ï¼ˆRAGï¼‰
â”‚   â”œâ”€â”€ routers/                       # API è·¯ç”±ï¼ˆè–„å±‚ï¼Œ<20 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ ai.py                     # AI è€å¸ˆ API
â”‚   â”‚   â”œâ”€â”€ books.py                  # ä¹¦ç±ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ dictionary.py              # è¯å…¸æŸ¥è¯¢ API
â”‚   â”‚   â”œâ”€â”€ vocabulary.py              # è¯æ±‡ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ dicts.py                  # è¯å…¸ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ tts.py                    # TTS è¯­éŸ³åˆæˆ API
â”‚   â”‚   â”œâ”€â”€ bookmarks.py               # ä¹¦ç­¾ API
â”‚   â”‚   â”œâ”€â”€ vocabulary_snippet.py      # ä¾‹å¥æå–ä»»åŠ¡ API
â”‚   â”‚   â”œâ”€â”€ rag.py                    # RAG æ£€ç´¢å¢å¼º
â”‚   â”‚   â””â”€â”€ test.py                  # æµ‹è¯•ç«¯ç‚¹
â”‚   â”œâ”€â”€ services/                      # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåšå±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ dict_service.py            # è¯å…¸ä¸‰çº§æŸ¥è¯¢ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”‚   â”œâ”€â”€ book_service.py            # ä¹¦ç±è§£ææœåŠ¡
â”‚   â”‚   â”œâ”€â”€ deepseek_service.py        # DeepSeek AI é›†æˆ
â”‚   â”‚   â”œâ”€â”€ gemini_service.py          # Google Gemini é›†æˆ (å¤‡ç”¨)
â”‚   â”‚   â”œâ”€â”€ tts_service.py             # Edge-TTS è¯­éŸ³åˆæˆ
â”‚   â”‚   â”œâ”€â”€ cache_service.py            # ç¼“å­˜ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ mdx_service.py             # MDX è¯å…¸è§£æ
â”‚   â”‚   â”œâ”€â”€ ecdict_service.py          # ECDICT è¯å…¸æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ dict_manager.py            # è¯å…¸ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
â”‚   â”‚   â””â”€â”€ ...                     # å…¶ä»–æœåŠ¡
â”‚   â”œâ”€â”€ parsers/                       # æ–‡æ¡£è§£æå¼•æ“
â”‚   â”‚   â”œâ”€â”€ factory.py                # è§£æå™¨å·¥å‚
â”‚   â”‚   â”œâ”€â”€ pdf_parser.py             # PDF è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ epub_parser.py            # EPUB è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ txt_parser.py             # TXT è§£æå™¨
â”‚   â”‚   â””â”€â”€ base.py                  # åŸºç¡€è§£æå™¨æ¥å£
â”‚   â””â”€â”€ utils/                        # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ lemmatizer.py             # è¯å½¢è¿˜åŸ
â”‚       â”œâ”€â”€ priority_calculator_safe.py  # è¯æ±‡ä¼˜å…ˆçº§è®¡ç®—
â”‚       â””â”€â”€ text_chunker.py           # æ–‡æœ¬åˆ‡ç‰‡
â”œâ”€â”€ data/                             # SQLite æ•°æ®åº“
â”œâ”€â”€ uploads/                          # ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ migrations/                       # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ tests/                            # å•å…ƒæµ‹è¯•
â”œâ”€â”€ requirements.txt                    # Python ä¾èµ–
â””â”€â”€ run_backend.ps1                   # Windows å¯åŠ¨è„šæœ¬
```

### 3.2 æ¶æ„åˆ†å±‚è®¾è®¡

#### Router å±‚ï¼ˆè·¯ç”±å±‚ï¼‰- è–„å±‚è®¾è®¡

**èŒè´£**ï¼š
- æ¥æ”¶ HTTP è¯·æ±‚
- å‚æ•°éªŒè¯ï¼ˆPydanticï¼‰
- ä¸šåŠ¡é€»è¾‘åˆ†å‘åˆ° Service å±‚
- å“åº”åºåˆ—åŒ–

**è®¾è®¡åŸåˆ™**ï¼š
```python
# è·¯ç”±å‡½æ•° < 20 è¡Œ
@router.post("/")
async def create_item(
    data: ItemIn, 
    db: AsyncSession = Depends(get_db),
    bt: BackgroundTasks = None
):
    # å‚æ•°éªŒè¯ âœ…
    # ä¸šåŠ¡åˆ†å‘ âœ…
    return await service.create(db, data, bt)
```

#### Service å±‚ï¼ˆæœåŠ¡å±‚ï¼‰- ä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ

**æ ¸å¿ƒæœåŠ¡**ï¼š

##### a) dict_service.py - è¯å…¸ä¸‰çº§æŸ¥è¯¢æµæ°´çº¿
```python
# æŸ¥è¯¢ä¼˜å…ˆçº§
1. CacheDictionary (SQLite ç¼“å­˜)          â† æœ€å¿«ï¼ˆ<50msï¼‰
   â†“ å‘½ä¸­
è¿”å›ç»“æœ
   â†“ æœªå‘½ä¸­
2. æœ¬åœ° MDX/ECDICT è¯å…¸                 â† ä¸­ç­‰é€Ÿåº¦ï¼ˆ<200msï¼‰
   â†“ å‘½ä¸­
è¿”å›ç»“æœ + ç¼“å­˜åˆ° cache_dictionary
   â†“ æœªå‘½ä¸­
3. DeepSeek AI (é™çº§ä¸º Free API)        â† æœ€æ…¢ï¼ˆ<3sï¼‰
   â†“ æˆåŠŸ
è¿”å›ç»“æœ + ç¼“å­˜åˆ° cache_dictionary
```

##### b) deepseek_service.py - AI é›†æˆ (æ ¸å¿ƒ)
- **å•è¯é‡Šä¹‰ç”Ÿæˆ**ï¼šJSON æ ¼å¼è¾“å‡ºï¼ˆéŸ³æ ‡ã€é‡Šä¹‰ã€ä¾‹å¥ï¼‰
- **æ–‡æœ¬ç¿»è¯‘**ï¼šè‹±â†’ä¸­ç¿»è¯‘ï¼ˆ15s è¶…æ—¶ï¼‰
- **AI è€å¸ˆå¯¹è¯**ï¼šå¸¦ç³»ç»Ÿæç¤ºçš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¹è¯
- **æ¨èé—®é¢˜ç”Ÿæˆ**ï¼šæ¯æ¬¡å›ç­”åç”Ÿæˆ 3 ä¸ªç›¸å…³é—®é¢˜

##### c) gemini_service.py - Google Gemini é›†æˆ (å¤‡ç”¨)
- **åŠŸèƒ½**ï¼šä½œä¸º DeepSeek çš„å¤‡ç”¨æ–¹æ¡ˆæˆ–ç”¨äºç‰¹å®šä»»åŠ¡
- **æ¨¡å‹**ï¼šgemini-3-flash-preview
- **çŠ¶æ€**ï¼šå·²é›†æˆ SDKï¼Œä½†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç›®å‰ä¸»è¦è·¯ç”±è‡³ DeepSeek

##### d) FTS5 æ£€ç´¢å¢å¼º (RAG) é€»è¾‘
- **å®ç°ä½ç½®**ï¼š`routers/ai.py` (knowledge_based_chat_fts5)
- **é™çº§ç­–ç•¥**ï¼šä½œä¸ºå‘é‡æ•°æ®åº“ (ChromaDB) çš„è½»é‡çº§æ›¿ä»£æ–¹æ¡ˆ
- **åŒä¹‰è¯æ˜ å°„**ï¼šå†…ç½®å¤šå­¦ç§‘ï¼ˆå¤©æ–‡ã€åœ°ç†ã€ç”Ÿç‰©ç­‰ï¼‰ä¸­è‹±æ–‡åŒä¹‰è¯è¡¨ï¼Œè‡ªåŠ¨æ‰©å±•æœç´¢å…³é”®è¯
- **é‡è¯•æœºåˆ¶**ï¼šç²¾ç¡®æœç´¢æ— ç»“æœ â†’ åŒä¹‰è¯æœç´¢ â†’ å½“å‰é¡µèŒƒå›´å…œåº•

##### e) book_service.py - ä¹¦ç±è§£ææœåŠ¡
- **æ–‡ä»¶ä¸Šä¼ å¤„ç†**ï¼šUUID å‘½å + æ–‡ä»¶ç±»å‹éªŒè¯
- **å¼‚æ­¥è§£æè§¦å‘**ï¼šBackgroundTasks åå°ä»»åŠ¡
- **Parser Factory**ï¼šæ ¹æ®æ‰©å±•åé€‰æ‹©è§£æå™¨
- **FTS5 ç´¢å¼•ç»´æŠ¤**ï¼šè‡ªåŠ¨åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•

##### d) tts_service.py - TTS è¯­éŸ³åˆæˆ
- **Edge-TTS å¼‚æ­¥ç”Ÿæˆ**
- **æ–‡ä»¶ç¼“å­˜æœºåˆ¶**ï¼šMD5 å“ˆå¸Œé˜²é‡å¤ç”Ÿæˆ
- **SSML åˆæˆæ”¯æŒ**ï¼šéŸ³è°ƒã€è¯­é€Ÿã€éŸ³é‡è°ƒèŠ‚

#### Model å±‚ï¼ˆæ¨¡å‹å±‚ï¼‰- ORM å®šä¹‰

**æ•°æ®åº“é…ç½®**ï¼ˆdatabase.pyï¼‰ï¼š
```python
# SQLite + aiosqlite å¼‚æ­¥é©±åŠ¨
DATABASE_URL = "sqlite+aiosqlite:///data/app.db"

# ä¾èµ–æ³¨å…¥æ¨¡å¼
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**æ•°æ®æ¨¡å‹**ï¼ˆmodels.pyï¼‰ï¼š
- **Book** - ä¹¦ç±å…ƒæ•°æ®
- **Page** - é¡µé¢å†…å®¹ + å•è¯åæ ‡
- **Vocabulary** - è¯æ±‡æœ¬ + ä¼˜å…ˆçº§è¯„åˆ†
- **ReadingProgress** - é˜…è¯»è¿›åº¦
- **CacheDictionary** - è¯å…¸ç¼“å­˜
- **Bookmark** - ä¹¦ç­¾
- **WordContext** - å•è¯ä¸Šä¸‹æ–‡

#### Parser å±‚ï¼ˆè§£æå™¨å±‚ï¼‰- Factory æ¨¡å¼

**Factory æ¨¡å¼**ï¼ˆfactory.pyï¼‰ï¼š
```python
class ParserFactory:
    @staticmethod
    def get_parser(file_path: str) -> BaseParser:
        ext = os.path.splitext(file_path)[1].lower()
        if ext == ".pdf": return PDFParser()
        elif ext == ".epub": return EPUBParser()
        elif ext == ".txt": return TXTParser()
        else: raise ValueError(f"Unsupported format: {ext}")
```

**PDF è§£æå™¨ç‰¹ç‚¹**ï¼ˆpdf_parser.pyï¼‰ï¼š
- **PyMuPDF (fitz)**ï¼šå­—ç¬¦çº§åæ ‡æå–
- **æ™ºèƒ½åˆ—æ£€æµ‹**ï¼šåŒæ æ’ç‰ˆèšç±»ç®—æ³•
- **å¤šæ èšç±»**ï¼šX åæ ‡ K-Means èšç±»
- **å•è¯åæ ‡é‡å»º**ï¼šéå† `chars` åˆ—è¡¨ç¡®ä¿å‡†ç¡®æ€§

**EPUB è§£æå™¨ç‰¹ç‚¹**ï¼ˆepub_parser.pyï¼‰ï¼š
- **ebooklib**ï¼šç« èŠ‚æå–
- **BeautifulSoup**ï¼šHTML æ¸…æ´—
- **å››çº§å°é¢å‘ç°**ï¼šå…ƒæ•°æ®ã€ID åŒ¹é…ã€æ–‡ä»¶åå…³é”®å­—ã€é¡ºåºå…œåº•

### 3.3 ä¸­é—´ä»¶ä¸ä¾èµ–æ³¨å…¥

#### ä¸­é—´ä»¶
- **CORSMiddleware**ï¼šè·¨åŸŸèµ„æºå…±äº«
  - å…è®¸æºï¼š`localhost:3000/3001`, `127.0.0.1:3000/3001`, `*`
  - å…è®¸æ–¹æ³•ï¼šæ‰€æœ‰
  - å…è®¸å¤´ï¼šæ‰€æœ‰
  - æš´éœ²å¤´ï¼šæ‰€æœ‰

- **StaticFiles**ï¼šé™æ€æ–‡ä»¶æœåŠ¡
  - `/uploads` - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶

#### ä¾èµ–æ³¨å…¥æ¨¡å¼
```python
# æ•°æ®åº“ä¾èµ–æ³¨å…¥
db: Session = Depends(get_db)

# åå°ä»»åŠ¡ä¾èµ–æ³¨å…¥
background_tasks: BackgroundTasks = BackgroundTasks

# Pydantic æ¨¡å‹è‡ªåŠ¨éªŒè¯
data: ModelIn  # è‡ªåŠ¨éªŒè¯å’Œååºåˆ—åŒ–
```

### 3.4 API ç«¯ç‚¹æ€»è§ˆ

**ä¹¦ç±ç®¡ç†**ï¼š
- `POST /api/books/upload` - ä¸Šä¼ ä¹¦ç±
- `GET /api/books/` - åˆ—å‡ºæ‰€æœ‰ä¹¦ç±
- `GET /api/books/{book_id}/status` - è·å–è§£æçŠ¶æ€
- `GET /api/books/{book_id}/content` - è·å–ä¹¦ç±æ–‡ä»¶
- `GET /api/books/{book_id}/pages/{page_number}` - è·å–é¡µé¢æ•°æ®
- `DELETE /api/books/{book_id}` - åˆ é™¤ä¹¦ç±
- `POST /api/books/{book_id}/progress` - ä¿å­˜é˜…è¯»è¿›åº¦

**è¯å…¸æŸ¥è¯¢**ï¼š
- `GET /api/dict/{word}` - æŸ¥è¯¢å•è¯é‡Šä¹‰
- `GET /api/dict/{word}/sources` - æ£€æŸ¥è¯å…¸å¯ç”¨æ€§
- `GET /api/dicts/` - åˆ—å‡ºæ‰€æœ‰è¯å…¸
- `POST /api/dicts/import` - å¯¼å…¥ MDX è¯å…¸

**å•è¯æœ¬**ï¼š
- `POST /api/vocabulary/` - æ·»åŠ ç”Ÿè¯
- `GET /api/vocabulary/` - è·å–å•è¯åˆ—è¡¨
- `GET /api/vocabulary/{vocab_id}` - è·å–å•è¯è¯¦æƒ…
- `DELETE /api/vocabulary/{vocab_id}` - åˆ é™¤ç”Ÿè¯
- `PATCH /api/vocabulary/{vocab_id}/mastery` - æ›´æ–°æŒæ¡åº¦
- `POST /api/vocabulary/query` - è®°å½•æŸ¥è¯¢æ¬¡æ•°
- `POST /api/vocabulary_snippet/{vocab_id}/extract_examples` - æ‰‹åŠ¨è§¦å‘ä¾‹å¥æå–

**AI èŠå¤©**ï¼š
- `POST /api/ai/chat` - AI å¯¹è¯ï¼ˆè‡ªåŠ¨æ„å›¾è¯†åˆ«ï¼‰

**TTS**ï¼š
- `POST /api/tts/` - ç”Ÿæˆè¯­éŸ³ï¼ˆç¼“å­˜æ¨¡å¼ï¼‰
- `POST /api/tts/stream` - æµå¼è¯­éŸ³åˆæˆ
- `GET /api/tts/voices` - åˆ—å‡ºå¯ç”¨å£°éŸ³

**ä¹¦ç­¾**ï¼š
- `POST /api/bookmarks/` - æ·»åŠ ä¹¦ç­¾
- `GET /api/bookmarks/` - è·å–ä¹¦ç­¾åˆ—è¡¨
- `DELETE /api/bookmarks/{bookmark_id}` - åˆ é™¤ä¹¦ç­¾

**å…¶ä»–**ï¼š
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /api/test/ping` - å¥åº·æ£€æŸ¥

### 3.5 å®šæ—¶ä»»åŠ¡

**ä½¿ç”¨**ï¼šAPScheduler åå°è°ƒåº¦å™¨

**é…ç½®**ï¼ˆmain.pyï¼‰ï¼š
```python
scheduler = BackgroundScheduler()
scheduler.add_job(
    scheduled_priority_update, 
    "cron", 
    hour=3, minute=0,  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹
    id="daily_priority_update"
)
```

**åŠŸèƒ½**ï¼š
- æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ›´æ–°æ‰€æœ‰å•è¯ä¼˜å…ˆçº§åˆ†æ•°
- åŸºäºæŸ¥è¯¢é¢‘æ¬¡ã€æŒæ¡åº¦ã€æœ€åæŸ¥è¯¢æ—¶é—´è®¡ç®—

### 3.6 å¼‚å¸¸å¤„ç†

**å½“å‰çŠ¶æ€**ï¼š
- æ— å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- ä½¿ç”¨ FastAPI å†…ç½® `HTTPException`
- æ‰‹åŠ¨æ•è·å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—

**é”™è¯¯å¤„ç†æ¨¡å¼**ï¼š
```python
try:
    # ä¸šåŠ¡é€»è¾‘
    pass
except Exception as e:
    logger.error(f"Error: {e}", exc_info=True)
    raise HTTPException(status_code=500, detail=str(e))
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ•°æ®åº“æ¦‚è§ˆ

**æ•°æ®åº“å¼•æ“**: SQLite 3.9+ (æ”¯æŒ FTS5)
**è¿æ¥è·¯å¾„**: `backend/data/app.db`
**ORM æ¡†æ¶**: SQLAlchemy 2.0 (å£°æ˜å¼åŸºç±» Base)
**è®¾è®¡æ¨¡å¼**: Anemic Domain Model (ä¸å®šä¹‰ ORM relationshipï¼Œé€šè¿‡å¤–é”®æ‰‹åŠ¨ join)

### 4.2 æ ¸å¿ƒè¡¨ç»“æ„

#### books (ä¹¦ç±è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | String | PK, INDEX | ä¹¦ç±å”¯ä¸€æ ‡è¯†ç¬¦ (UUID/Hash) |
| title | String | NOT NULL | ä¹¦ç±æ ‡é¢˜ |
| author | String | NULLABLE | ä½œè€… |
| format | String | NOT NULL | æ–‡ä»¶æ ¼å¼ (pdf/epub/txt) |
| file_path | String | NOT NULL | æ–‡ä»¶å­˜å‚¨è·¯å¾„ |
| cover_image | String | NULLABLE | å°é¢å›¾ç‰‡è·¯å¾„ |
| total_pages | Integer | NULLABLE | æ€»é¡µæ•° |
| status | String | DEFAULT 'processing' | å¤„ç†çŠ¶æ€ (processing/ready/failed) |
| book_type | String | DEFAULT 'normal' | ä¹¦ç±ç±»å‹ (normal/example_library) |
| created_at | DateTime(tz=True) | DEFAULT now() | åˆ›å»ºæ—¶é—´ (UTC) |

**å…³ç³»**: ä½œä¸ºä¸»è¡¨ï¼Œè¢« pagesã€reading_progressã€vocabularyã€bookmarksã€word_contexts å¼•ç”¨

#### pages (é¡µé¢è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PK, AUTO, INDEX | é¡µé¢ ID |
| book_id | String | FK, NOT NULL, INDEX | å…³è”ä¹¦ç± |
| page_number | Integer | NOT NULL | é¡µç  |
| text_content | Text | NULLABLE | æå–çš„æ–‡æœ¬å†…å®¹ |
| words_data | JSON | NULLABLE | å•è¯ä½ç½®æ•°æ® [{text, x, y, width, height}] |
| images | JSON | NULLABLE | å›¾ç‰‡ä½ç½®æ•°æ® |

**å¤–é”®**: `book_id â†’ books.id`
**ç‰¹ç‚¹**: æ”¯æŒå¯Œæ–‡æœ¬å’Œç»“æ„åŒ–æ•°æ®å­˜å‚¨ (words_data ç”¨äº PDF å•è¯å®šä½)

#### vocabulary (è¯æ±‡æœ¬è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PK, AUTO, INDEX | è®°å½• ID |
| word | String | NOT NULL, INDEX | å•è¯ (å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è¯¢) |
| phonetic | String | NULLABLE | éŸ³æ ‡ |
| definition | Text | NULLABLE | è‹±æ–‡é‡Šä¹‰ |
| translation | Text | NULLABLE | ä¸­æ–‡ç¿»è¯‘ |
| audio_url | String | NULLABLE | å‘éŸ³éŸ³é¢‘ URL |
| book_id | String | FK | å…³è”ä¹¦ç± (æ¥æº) |
| page_number | Integer | NULLABLE | æ‰€åœ¨é¡µç  |
| context | Text | NULLABLE | å•è¯ä¸Šä¸‹æ–‡å¥å­ |
| mastery_level | Integer | DEFAULT 1 | æŒæ¡ç­‰çº§ (1-5 çº§) |
| review_count | Integer | DEFAULT 0 | å¤ä¹ æ¬¡æ•° |
| last_reviewed_at | DateTime(tz=True) | NULLABLE | æœ€åå¤ä¹ æ—¶é—´ |
| difficulty_score | Integer | DEFAULT 0 | éš¾åº¦è¯„åˆ† |
| next_review_at | DateTime(tz=True) | NULLABLE | ä¸‹æ¬¡å¤ä¹ æ—¶é—´ (é—´éš”é‡å¤ç®—æ³•) |
| created_at | DateTime(tz=True) | DEFAULT now() | åˆ›å»ºæ—¶é—´ |

**å¤–é”®**: `book_id â†’ books.id`
**ç‰¹ç‚¹**: æ”¯æŒé—´éš”é‡å¤å­¦ä¹  (Spaced Repetition)ï¼Œé€šè¿‡ mastery_levelã€next_review_at å®ç°

#### reading_progress (é˜…è¯»è¿›åº¦è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PK, AUTO, INDEX | è¿›åº¦è®°å½• ID |
| book_id | String | FK, NOT NULL, UNIQUE | å…³è”ä¹¦ç± (æ¯æœ¬ä¹¦å”¯ä¸€) |
| current_page | Integer | DEFAULT 1 | å½“å‰é˜…è¯»é¡µç  |
| total_read_time | Integer | DEFAULT 0 | ç´¯è®¡é˜…è¯»æ—¶é—´ (ç§’) |
| updated_at | DateTime(tz=True) | AUTO | è‡ªåŠ¨æ›´æ–°æ—¶é—´ |

**å¤–é”®**: `book_id â†’ books.id (UNIQUE)`
**çº¦æŸ**: æ¯æœ¬ä¹¦åªæœ‰ä¸€æ¡è¿›åº¦è®°å½• (UNIQUE book_id)

#### cache_dictionary (è¯å…¸ç¼“å­˜è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| word | String | PK, INDEX | å•è¯ (ä¸»é”®) |
| data | JSON | NOT NULL | ç¼“å­˜çš„è¯å…¸æ•°æ® (JSON æ ¼å¼) |
| created_at | DateTime(tz=True) | DEFAULT now() | ç¼“å­˜æ—¶é—´ |

**ç”¨é€”**: ç¼“å­˜ AI ç”Ÿæˆçš„è¯ä¹‰è§£æï¼Œé¿å…é‡å¤è°ƒç”¨ LLM API

#### cache_audio (éŸ³é¢‘ç¼“å­˜è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| text_hash | String | PK, INDEX | æ–‡æœ¬å“ˆå¸Œ (ä¸»é”®) |
| audio_data | LargeBinary | NOT NULL | äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ® |
| created_at | DateTime(tz=True) | DEFAULT now() | ç¼“å­˜æ—¶é—´ |

**ç”¨é€”**: TTS éŸ³é¢‘ç¼“å­˜ï¼Œé¿å…é‡å¤åˆæˆç›¸åŒæ–‡æœ¬

#### bookmarks (ä¹¦ç­¾è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PK, AUTO, INDEX | ä¹¦ç­¾ ID |
| book_id | String | FK, NOT NULL | å…³è”ä¹¦ç± |
| page_number | Integer | NOT NULL | ä¹¦ç­¾é¡µç  |
| title | String | NULLABLE | ä¹¦ç­¾æ ‡é¢˜ (ç”¨æˆ·è‡ªå®šä¹‰) |
| note | Text | NULLABLE | å¤‡æ³¨ |
| created_at | DateTime(tz=True) | DEFAULT now() | åˆ›å»ºæ—¶é—´ |

**å¤–é”®**: `book_id â†’ books.id`

#### word_contexts (å•è¯ä¸Šä¸‹æ–‡è¡¨)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | PK, AUTO, INDEX | ä¸Šä¸‹æ–‡ ID |
| word | String | NOT NULL, INDEX | å•è¯ |
| book_id | String | FK, NOT NULL | å…³è”ä¹¦ç± |
| page_number | Integer | NOT NULL | æ‰€åœ¨é¡µç  |
| context_sentence | Text | NOT NULL | ä¸Šä¸‹æ–‡å¥å­ |
| is_primary | Integer | DEFAULT 0 | 0=é¢å¤–ä¾‹å¥, 1=ä¸»è¦ä¸Šä¸‹æ–‡ |
| source_type | String | DEFAULT 'user_collected' | æ¥æºç±»å‹ |
| created_at | DateTime(tz=True) | DEFAULT now() | åˆ›å»ºæ—¶é—´ |

**å¤–é”®**: `book_id â†’ books.id`
**ç‰¹ç‚¹**: æ”¯æŒä¸€ä¸ªå•è¯å¤šä¸ªä¸Šä¸‹æ–‡ä¾‹å¥ï¼Œis_primary æ ‡è®°ä¸»è¦æ¥æº

#### pages_fts (FTS5 è™šæ‹Ÿè¡¨ - å…¨æ–‡æœç´¢)

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | Integer | UNINDEXED | é¡µé¢ ID (ä¸ç´¢å¼•) |
| book_id | String | UNINDEXED | ä¹¦ç± ID (ä¸ç´¢å¼•) |
| page_number | Integer | UNINDEXED | é¡µç  (ä¸ç´¢å¼•) |
| text_content | Text | INDEXED | æ–‡æœ¬å†…å®¹ (å…¨æ–‡æœ¬ç´¢å¼•) |

**åŒæ­¥æœºåˆ¶**: é€šè¿‡è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ pages è¡¨çš„å˜æ›´
- `pages_ai` (INSERT) - æ–°å¢è®°å½•æ—¶åŒæ­¥
- `pages_au` (UPDATE) - æ›´æ–°è®°å½•æ—¶åŒæ­¥
- `pages_ad` (DELETE) - åˆ é™¤è®°å½•æ—¶åŒæ­¥

**æ€§èƒ½ä¼˜åŒ–**: UNINDEXED å­—æ®µå‡å°‘ç´¢å¼•å¤§å°ï¼Œä»…å¯¹ text_content å»ºç«‹å…¨æ–‡ç´¢å¼•

### 4.3 å…³è”å…³ç³»

```
books (1)
â”œâ”€â”€ (N) pages
â”œâ”€â”€ (1) reading_progress (UNIQUE)
â”œâ”€â”€ (N) vocabulary
â”œâ”€â”€ (N) bookmarks
â””â”€â”€ (N) word_contexts

pages (1)
â””â”€â”€ (N) page_chunks (CASCADE DELETE)
```

### 4.4 ç´¢å¼•ä¸çº¦æŸ

**ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰**ï¼š
- books.id
- pages.id
- vocabulary.id
- reading_progress.id
- cache_dictionary.word
- cache_audio.text_hash
- bookmarks.id
- word_contexts.id

**é¢å¤–å¤–é”®ç´¢å¼•ï¼ˆæ˜¾å¼å£°æ˜ï¼‰**ï¼š
- pages.book_id
- vocabulary.word
- reading_progress.book_id (UNIQUE)
- page_chunks.page_id (CASCADE DELETE)

---

## 5. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 5.1 å¤šæ ¼å¼é˜…è¯»å™¨

#### PDF é˜…è¯»
**æŠ€æœ¯æ ˆ**: react-pdf + PyMuPDF
**ç‰¹ç‚¹**:
- Canvas æ¸²æŸ“ + TextLayer äº¤äº’å±‚
- å­—ç¬¦çº§åæ ‡æå–ï¼ˆ`words_data` JSONï¼‰
- æ™ºèƒ½åˆ—æ£€æµ‹ï¼ˆåŒæ æ’ç‰ˆèšç±»ç®—æ³•ï¼‰
- æ”¯æŒç¼©æ”¾ + ç¿»é¡µ

#### EPUB é˜…è¯»
**æŠ€æœ¯æ ˆ**: epub.js + ebooklib + BeautifulSoup
**ç‰¹ç‚¹**:
- iframe/rendition æ¸²æŸ“
- ç« èŠ‚æå– + ç›®å½•æ ‘
- å››çº§å°é¢å‘ç°æœºåˆ¶
- æ–‡æœ¬å®æ—¶æå–

#### TXT é˜…è¯»
**æŠ€æœ¯æ ˆ**: åŸç”Ÿæ¸²æŸ“ + å¤šç¼–ç æ£€æµ‹
**ç‰¹ç‚¹**:
- è‡ªåŠ¨è¯†åˆ«ç¼–ç  (UTF-8/GBK)
- æŒ‰æ®µè½åˆ†é¡µ
- æ¨¡æ‹Ÿå•è¯åæ ‡

### 5.2 ä¸‰çº§è¯å…¸æŸ¥è¯¢

```python
# æŸ¥è¯¢æµæ°´çº¿ï¼ˆdict_service.pyï¼‰
def lookup_word(db, word):
    # 1. ç¼“å­˜æŸ¥è¯¢
    cached = db.query(CacheDictionary).filter_by(word=word).first()
    if cached: return cached.data
    
    # 2. æœ¬åœ°è¯å…¸æŸ¥è¯¢ï¼ˆMDX/ECDICTï¼‰
    local_result = dict_manager.lookup_word(word)
    if local_result:
        cache_service.save_dictionary_cache(db, word, local_result)
        return local_result
    
    # 3. å¤–éƒ¨ API æŸ¥è¯¢
    api_result = fetch_from_free_api(word)
    cache_service.save_dictionary_cache(db, word, api_result)
    return api_result
```

**è¯å½¢è¿˜åŸ**ï¼š
- æ”¯æŒå¤æ•°ã€è¿‡å»å¼ã€è¿›è¡Œæ—¶ã€æ¯”è¾ƒçº§ã€æœ€é«˜çº§
- ä¾‹å¤–è¯åˆ—è¡¨ï¼ˆå¦‚ "evening" ä¸è¿˜åŸä¸º "even"ï¼‰
- éªŒè¯å€™é€‰è¯åœ¨è¯å…¸ä¸­å­˜åœ¨

### 5.3 AI è€å¸ˆåŠ©æ‰‹

#### æ„å›¾è¯†åˆ«ï¼ˆclassify_user_intentï¼‰
```python
# å…³é”®è¯åˆ†ç±»
language_learning = ["è®²è§£", "ç¿»è¯‘", "æ„æ€", "è¯­æ³•"]
content_location = ["åœ¨å“ªé‡Œ", "ç¬¬å‡ é¡µ", "æœç´¢"]
knowledge_retrieval = ["æåˆ°", "è®²è¿‡", "æ¦‚å¿µ"]
reading_comprehension = ["æ€»ç»“", "æ¦‚è¿°", "ä¸»é¢˜"]
```

#### ä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¹è¯
- åŸºäºå½“å‰é˜…è¯»é¡µé¢çš„å†…å®¹ï¼ˆæœ€è¿‘ 5000 å­—ç¬¦ï¼‰
- æ”¯æŒå¯¹è¯å†å²è®°å½•
- æ¨èé—®é¢˜è‡ªåŠ¨ç”Ÿæˆ
- æ¥æºå¼•ç”¨è·³è½¬ï¼ˆFTS5 æ£€ç´¢ç»“æœï¼‰

### 5.4 å•è¯æœ¬ç®¡ç†

#### ä¼˜å…ˆçº§è¯„åˆ†ç®—æ³•
```python
# priority_calculator_safe.py
def calculate_priority_score(word_dict):
    query_weight = 10
    review_weight = 5
    mastery_weight = 10
    
    priority = (word_dict['query_count'] * query_weight +
                word_dict['review_count'] * review_weight +
                ((5 - word_dict['mastery_level']) * mastery_weight) +
                time_decay_score)
    
    return min(max(priority, 0), 100)  # é™åˆ¶åœ¨ 0-100 èŒƒå›´
```

#### å­¦ä¹ çŠ¶æ€åˆ†ç±»
- **urgent** (priority_score >= 80): ç´§æ€¥å¤ä¹ 
- **review** (60 <= priority_score < 80): éœ€è¦å¤ä¹ 
- **learning** (40 <= priority_score < 60): å­¦ä¹ ä¸­
- **mastered** (priority_score < 40): å·²æŒæ¡

#### ä¾‹å¥æå–
```python
# FTS5 å…¨æ–‡æœç´¢
query_str = '''
    SELECT p.id, p.book_id, p.page_number, p.text_content
    FROM pages p
    INNER JOIN pages_fts fts ON p.id = fts.rowid
    INNER JOIN books b ON p.book_id = b.id
    WHERE fts.text_content MATCH :word
      AND b.book_type = 'example_library'
'''
```

### 5.5 å…¨æ–‡æ£€ç´¢ï¼ˆFTS5ï¼‰

#### è™šæ‹Ÿè¡¨å®šä¹‰
```sql
CREATE VIRTUAL TABLE pages_fts USING fts5(
    id UNINDEXED,
    book_id UNINDEXED,
    page_number UNINDEXED,
    text_content
);
```

#### è§¦å‘å™¨åŒæ­¥
- `pages_ai` - AFTER INSERT ON pages
- `pages_au` - AFTER UPDATE ON pages
- `pages_ad` - AFTER DELETE ON pages

#### æ£€ç´¢åŠŸèƒ½
- å…³é”®è¯åŒ¹é…ï¼ˆæ”¯æŒè¯å½¢è¿˜åŸï¼‰
- é«˜äº®æ˜¾ç¤ºåŒ¹é…æ–‡æœ¬
- æŒ‰ç›¸å…³æ€§æ’åº
- è·¨ä¹¦ç±æœç´¢

### 5.6 TTS è¯­éŸ³åˆæˆ

#### Edge-TTS é›†æˆ
```python
# tts_service.py
async def generate_speech(text):
    # æ£€æŸ¥ç¼“å­˜
    text_hash = hashlib.md5(text.encode()).hexdigest()
    cached = db.query(CacheAudio).filter_by(text_hash=text_hash).first()
    if cached:
        return cached.audio_data
    
    # ç”Ÿæˆæ–°éŸ³é¢‘
    audio = await edge_tts_service.synthesize(text)
    
    # ç¼“å­˜åˆ°æ•°æ®åº“
    cache_service.save_audio_cache(db, text_hash, audio)
    
    return audio
```

#### SSML æ”¯æŒ
- éŸ³è°ƒè°ƒèŠ‚
- è¯­é€Ÿæ§åˆ¶
- éŸ³é‡è°ƒèŠ‚

---

## 6. éƒ¨ç½²æ¶æ„

### 6.1 å¼€å‘ç¯å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¼€å‘è€…æœºå™¨                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å‰ç«¯ Dev    â”‚  â”‚  åç«¯ Dev    â”‚         â”‚
â”‚  â”‚  npm run dev  â”‚  â”‚  python -m   â”‚         â”‚
â”‚  â”‚  :3000        â”‚  â”‚  uvicorn ... â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚
          â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SQLite æ•°æ®åº“                      â”‚
â”‚           (backend/data/app.db)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç”Ÿäº§ç¯å¢ƒï¼ˆè§„åˆ’ï¼‰

**å‰ç«¯**:
- Vercel / Netlify éƒ¨ç½²
- CDN åŠ é€Ÿé™æ€èµ„æº
- ç¯å¢ƒå˜é‡ç®¡ç†

**åç«¯**:
- Docker å®¹å™¨åŒ–éƒ¨ç½²
- Nginx åå‘ä»£ç†
- Gunicorn/Uvicorn å¤šè¿›ç¨‹

**æ•°æ®åº“**:
- SQLite è½»é‡éƒ¨ç½²
- å®šæœŸå¤‡ä»½ç­–ç•¥
- æœªæ¥è¿ç§»åˆ° PostgreSQLï¼ˆå¦‚éœ€é«˜å¹¶å‘ï¼‰

---

## 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 å‰ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æŠ€æœ¯ | é¢„æœŸæ•ˆæœ |
|--------|------|----------|
| **ä»£ç åˆ†å‰²** | Next.js Dynamic Import | å‡å°‘åˆå§‹åŠ è½½ä½“ç§¯ |
| **å›¾ç‰‡æ‡’åŠ è½½** | React.lazy + IntersectionObserver | å‡å°‘é¦–å±åŠ è½½æ—¶é—´ |
| **ç¼“å­˜ç­–ç•¥** | localStorage + IndexedDB | å‡å°‘é‡å¤ API è°ƒç”¨ |
| **é˜²æŠ–èŠ‚æµ** | é˜²æŠ– 300ms | å‡å°‘ä¸å¿…è¦çš„ API è¯·æ±‚ |
| **è™šæ‹Ÿæ»šåŠ¨** | react-window | å¤§åˆ—è¡¨æ¸²æŸ“æ€§èƒ½æå‡ |

### 7.2 åç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æŠ€æœ¯ | é¢„æœŸæ•ˆæœ |
|--------|------|----------|
| **FTS5 å…¨æ–‡æœç´¢** | MATCH æŸ¥è¯¢ä¼˜äº LIKE | æœç´¢æ€§èƒ½æå‡ 10x+ |
| **æ‰¹é‡æŸ¥è¯¢** | in_() æ“ä½œæ›¿ä»£å¾ªç¯ | å‡å°‘æ•°æ®åº“å¾€è¿” |
| **è¿æ¥æ± ** | SQLAlchemy è¿æ¥æ±  | å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€ |
| **ç¼“å­˜æœºåˆ¶** | è¯å…¸ç¼“å­˜ + TTS ç¼“å­˜ | å‡å°‘ API è°ƒç”¨ 80%+ |
| **åå°ä»»åŠ¡** | BackgroundTasks å¼‚æ­¥å¤„ç† | ä¸é˜»å¡ä¸»çº¿ç¨‹ |

### 7.3 æ•°æ®åº“ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æŠ€æœ¯ | é¢„æœŸæ•ˆæœ |
|--------|------|----------|
| **ç´¢å¼•ä¼˜åŒ–** | å¤åˆç´¢å¼• (word, book_id) | å¸¸ç”¨æŸ¥è¯¢åŠ é€Ÿ |
| **FTS5 ç´¢å¼•** | è™šæ‹Ÿè¡¨å…¨æ–‡ç´¢å¼• | å…¨æ–‡æœç´¢æ€§èƒ½æå‡ |
| **æŸ¥è¯¢ä¼˜åŒ–** | åªé€‰æ‹©å¿…è¦å­—æ®µ | å‡å°‘æ•°æ®ä¼ è¾“ |
| **VACUUM** | å®šæœŸæ¸…ç†ç¢ç‰‡ | ä¿æŒæ•°æ®åº“æ€§èƒ½ |

---

## 8. å®‰å…¨è®¾è®¡

### 8.1 å‰ç«¯å®‰å…¨

- **XSS é˜²æŠ¤**: React é»˜è®¤è½¬ä¹‰ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ `dangerouslySetInnerHTML`
- **CSRF é˜²æŠ¤**: SameSite Cookieï¼ˆæœªæ¥ç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼‰
- **å†…å®¹å®‰å…¨ç­–ç•¥**: é…ç½® CSP å¤´ï¼ˆNext.js æ”¯æŒï¼‰
- **è¾“å…¥éªŒè¯**: TypeScript ç±»å‹æ£€æŸ¥ + è¿è¡Œæ—¶éªŒè¯

### 8.2 åç«¯å®‰å…¨

- **SQL æ³¨å…¥é˜²æŠ¤**: ä½¿ç”¨ SQLAlchemy ORM å‚æ•°åŒ–æŸ¥è¯¢
- **è·¯å¾„éå†é˜²æŠ¤**: æ–‡ä»¶ä¸Šä¼ è·¯å¾„éªŒè¯ï¼ˆ`..` è¿‡æ»¤ï¼‰
- **è¾“å…¥éªŒè¯**: Pydantic æ¨¡å‹è‡ªåŠ¨éªŒè¯
- **CORS é…ç½®**: ä»…å…è®¸å¿…è¦åŸŸå
- **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**: ç¯å¢ƒå˜é‡ç®¡ç† API Key

### 8.3 æ•°æ®å®‰å…¨

- **ç¯å¢ƒå˜é‡**: `.env` æ–‡ä»¶ï¼ˆä¸æäº¤åˆ° Gitï¼‰
- **æ–‡ä»¶ä¸Šä¼ **: é™åˆ¶æ–‡ä»¶å¤§å°å’Œç±»å‹
- **æ•°æ®å¤‡ä»½**: å®šæœŸ SQLite æ•°æ®åº“å¤‡ä»½
- **æ—¥å¿—è„±æ•**: é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯

---

## 9. ç›‘æ§ä¸æ—¥å¿—

### 9.1 å‰ç«¯æ—¥å¿—

```typescript
// lib/logger.ts
const log = createLogger('ModuleName');

// ç¯å¢ƒå˜é‡æ§åˆ¶
// NEXT_PUBLIC_LOG_LEVEL=debug/info/warn/error/none
```

**æ—¥å¿—çº§åˆ«**:
- **debug**: è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- **info**: ä¸€èˆ¬ä¿¡æ¯
- **warn**: è­¦å‘Šä¿¡æ¯
- **error**: é”™è¯¯ä¿¡æ¯
- **none**: å…³é—­æ‰€æœ‰æ—¥å¿—

### 9.2 åç«¯æ—¥å¿—

```python
# loguru é…ç½®
logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)

# æ—¥å¿—æ ¼å¼
# %(asctime)s - %(name)s - %(levelname)s - %(message)s
```

**æ—¥å¿—è®°å½•**:
- API è¯·æ±‚æ—¥å¿—
- ä¸šåŠ¡é€»è¾‘æ—¥å¿—
- é”™è¯¯å †æ ˆè·Ÿè¸ª
- æ€§èƒ½æŒ‡æ ‡è®°å½•

---

## 10. å¼€å‘è§„èŒƒä¸æœ€ä½³å®è·µ

### 10.1 å‰ç«¯è§„èŒƒ

**å¿…é¡»éµå®ˆ**:
- **API å‚æ•°**: å‰ç«¯å‘é€ snake_caseï¼ˆå¦‚ `page_content`ï¼‰
- **æ—¥å¿—å·¥å…·**: å¿…é¡»ä½¿ç”¨ `lib/logger.ts`ï¼Œç¦æ­¢ `console.log`
- **è·¯ç”±å¯¼èˆª**: ä½¿ç”¨ `useRouter`ï¼Œç¦æ­¢ `window.location`
- **æ ·å¼æ–¹æ¡ˆ**: Tailwind CSS 4 ä¼˜å…ˆ
- **API è¯·æ±‚**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `/api/...` è§¦å‘ Next.js Rewrite

**ç¦æ­¢æ¨¡å¼**:
- âŒ ç¡¬ç¼–ç åç«¯ URL
- âŒ ç›´æ¥ä½¿ç”¨ `console.log/warn/error`
- âŒ åœ¨éé˜…è¯»å™¨å®šä½åœºæ™¯ä½¿ç”¨å†…è”æ ·å¼
- âŒ ç»„ä»¶æ–‡ä»¶è¶…è¿‡ 300 è¡Œ
- âŒ è¿‡åº¦ä½¿ç”¨ Context APIï¼ˆä¼˜å…ˆ Zustandï¼‰

### 10.2 åç«¯è§„èŒƒ

**å¿…é¡»éµå®ˆ**:
- **Router è–„å±‚**: è·¯ç”±å‡½æ•° < 20 è¡Œï¼Œä¸šåŠ¡é€»è¾‘ä¸‹æ²‰åˆ° Service å±‚
- **Async Only**: æ‰€æœ‰ç«¯ç‚¹ä½¿ç”¨ `async def`
- **ä¾èµ–æ³¨å…¥**: ç»Ÿä¸€é€šè¿‡ `Depends(get_db)` æ³¨å…¥ DB Session
- **è·¯å¾„å¤„ç†**: å¿…é¡»ä½¿ç”¨ `pathlib.Path`ï¼Œé€šè¿‡ `BASE_DIR` ç»Ÿä¸€ç®¡ç†
- **Pydantic é©±åŠ¨**: å¿…é¡»å®šä¹‰ Pydantic æ¨¡å‹éªŒè¯è¾“å…¥

**ç¦æ­¢æ¨¡å¼**:
- âŒ Router ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘
- âŒ Router ä¸­ç›´æ¥è°ƒç”¨ ORM æ‰§è¡Œè¯­å¥
- âŒ åœ¨ `async def` ä¸­ä½¿ç”¨åŒæ­¥ `requests` åº“
- âŒ Router ä¸­æ‰‹åŠ¨å…³é—­æ•°æ®åº“è¿æ¥
- âŒ æäº¤ `.env`ã€å¯†é’¥ã€æ•°æ®åº“æ–‡ä»¶

---

## 11. ç‰ˆæœ¬è§„åˆ’

### 11.1 å½“å‰ç‰ˆæœ¬ï¼ˆv1.0ï¼‰- å·²å®Œæˆ

- âœ… PDF/EPUB/TXT å¤šæ ¼å¼é˜…è¯»å™¨
- âœ… ä¸‰çº§è¯å…¸æŸ¥è¯¢æœºåˆ¶
- âœ… AI è€å¸ˆåŠ©æ‰‹ï¼ˆæ„å›¾è¯†åˆ« + ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼‰
- âœ… å•è¯æœ¬ç®¡ç†ï¼ˆä¼˜å…ˆçº§è¯„åˆ†ç³»ç»Ÿï¼‰
- âœ… ä¾‹å¥è‡ªåŠ¨æå–ï¼ˆFTS5 å…¨æ–‡æœç´¢ï¼‰
- âœ… å…¨æ–‡æ£€ç´¢åŠŸèƒ½
- âœ… TTS è¯­éŸ³åˆæˆï¼ˆEdge-TTSï¼‰
- âœ… ç¬”è®°ä¸ä¹¦ç­¾ç®¡ç†

### 11.2 è§„åˆ’ç‰ˆæœ¬ï¼ˆv1.1ï¼‰

- ğŸ”„ å•è¯æœ¬æ•°æ®å¯¼å…¥/å¯¼å‡ºï¼ˆCSV/JSONï¼‰
- ğŸ”„ é˜…è¯»ç»Ÿè®¡æŠ¥è¡¨ï¼ˆé˜…è¯»æ—¶é•¿ã€é¡µæ•°ã€å•è¯æ•°ï¼‰
- ğŸ”„ ç¦»çº¿æ¨¡å¼æ”¯æŒï¼ˆService Worker ç¼“å­˜ï¼‰
- ğŸ”„ å¤šç”¨æˆ·æ”¯æŒï¼ˆç”¨æˆ·ç™»å½•/æƒé™ç®¡ç†ï¼‰
- ğŸ”„ åŒæ­¥äº‘ç«¯å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

### 11.3 æœªæ¥ç‰ˆæœ¬ï¼ˆv2.0ï¼‰

- â³ AI å†™ä½œåŠ©æ‰‹ï¼ˆåŸºäºé˜…è¯»å†…å®¹çš„å†™ä½œå»ºè®®ï¼‰
- â³ æ™ºèƒ½æ‘˜è¦ç”Ÿæˆï¼ˆå…¨ä¹¦ç« èŠ‚æ‘˜è¦ï¼‰
- â³ ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ï¼ˆåŸºäºè¯æ±‡é‡æ¨èï¼‰
- â³ åä½œå­¦ä¹ æ¨¡å¼ï¼ˆå…±äº«ç¬”è®°/è®¨è®ºï¼‰
- â³ ç§»åŠ¨ç«¯ Appï¼ˆReact Native ç‰ˆæœ¬ï¼‰

---

## 12. é™„å½•

### 12.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| FTS5 | SQLite å…¨æ–‡æœç´¢æ‰©å±• |
| MDX/MDD | è¯å…¸æ•°æ®æ–‡ä»¶æ ¼å¼ |
| ECDICT | è‹±æ±‰è¯å…¸æ•°æ®åº“ |
| Edge-TTS | Microsoft Edge è¯­éŸ³åˆæˆ API |
| AI è€å¸ˆ | åŸºäº LLM çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ |
| ä¸‰çº§æŸ¥è¯¢ | ç¼“å­˜ â†’ æœ¬åœ° â†’ AI çš„è¯å…¸æŸ¥è¯¢æœºåˆ¶ |
| Anemic Domain Model |è´«è¡€é¢†åŸŸæ¨¡å‹ï¼ˆæ¨¡å‹ä¸å«ä¸šåŠ¡é€»è¾‘ï¼‰ |
| Thin Router | è–„å±‚è·¯ç”±ï¼ˆè·¯ç”±å±‚é€»è¾‘ç®€å•ï¼‰ |
| Thick Service | åšå±‚æœåŠ¡ï¼ˆæœåŠ¡å±‚åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼‰ |
| App Router | Next.js è·¯ç”±ç³»ç»Ÿï¼ˆåŸºäºæ–‡ä»¶ç³»ç»Ÿï¼‰ |

### 12.2 å‚è€ƒèµ„æ–™

- [Next.js å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs)
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [React 19 æ–‡æ¡£](https://react.dev/)
- [Tailwind CSS 4 æ–‡æ¡£](https://tailwindcss.com/)
- [SQLite FTS5 æ–‡æ¡£](https://www.sqlite.org/fts3.html)
- [DeepSeek API æ–‡æ¡£](https://api-docs.deepseek.com/)
- [SQLAlchemy 2.0 æ–‡æ¡£](https://docs.sqlalchemy.org/en/20/)

---

**æ–‡æ¡£ç»“æŸ**
